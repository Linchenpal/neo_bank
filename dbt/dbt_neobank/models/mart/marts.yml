version: 2

models:
  - name: mart_user_notifications
    description: "{{ doc('__mart_user_notifications') }}"
    columns:
      - name: user_id
        description: "{{ doc('__user_id') }}"
        tests:
          - not_null
      - name: notification_id
        description: "{{ doc('__notification_id') }}"
        tests:
          - not_null
      - name: channel
        description: "{{ doc('__channel') }}"
        tests:
          - not_null
      - name: reason
        description: "{{ doc('__reason') }}"
        tests:
          - not_null
      - name: status
        description: "{{ doc('__status') }}"
        tests:
          - not_null
      - name: valid_from
        description: "{{ doc('__load_date') }}"
        tests:
          - not_null
      - name: valid_to
        description: "{{ doc('__load_end_date') }}"
        tests:
          - not_null

  - name: mart_transactions
    description: a weekly view of the number of transactions per user
    columns:
        - name: transaction_month
          description: month of transaction date
          data_tests:
            - not_null
        - name: user_id
          description: "{{ doc('__user_id') }}"
          data_tests:
            - not_null
        - name: transaction_state
          description: "{{ doc('__transaction_state') }}"
          data_tests:
           - not_null
        - name: transaction_type
          description: "{{ doc('__transaction_type') }}"
          data_tests:
            - not_null
        - name: physical_transactions
          description: number of transactions where ea_cardholderpresence = 1
          data_tests:
            - dbt_utils.expression_is_true:
                expression: '>= 0'
        - name: online_transactions
          description: number of transactions where ea_cardholderpresence = 0
          data_tests:
            - dbt_utils.expression_is_true:
                expression: '>= 0'
        - name: inbound_transactions
          description: number of transactions where direction = inbound
          data_tests:
            - dbt_utils.expression_is_true:
                expression: '>= 0'
        - name: outbound_transactions
          description: number of transactions where direction = outbound
          data_tests:
            - dbt_utils.expression_is_true:
                expression: '>= 0'
        - name: total_transactions
          description: total number of transactions for that user for that week
          data_tests:
            - dbt_utils.expression_is_true:
                expression: '>= 0'
        - name: amount_usd
          description: USD value of all transactions the user made that week
          data_tests:
            - dbt_utils.expression_is_true:
                expression: '>= 0'

  - name: mart_user_settings
    description: >
      This data mart aggregates user settings and profile data, including device type, country, plan, date of birth, contact count, marketing preferences, and whether crypto is unlocked. It represents the user profile at a point in time for analytics and segmentation purposes.
    columns:
      - name: user_hk
        description: Surrogate key representing the unique user.
      - name: device_type
        description: The type of device most recently associated with the user.
      - name: country
        description: User's registered country.
      - name: plan
        description: Current plan assigned to the user (e.g. basic, premium).
      - name: birth_year
        description: Year of birth of the user.
      - name: num_contacts
        description: Number of contacts linked to the user account.
      - name: crypto_unlocked
        description: Boolean flag indicating if the user has unlocked crypto functionality.
      - name: marketing_push_enabled
        description: Whether the user has enabled push marketing notifications.
      - name: marketing_email_enabled
        description: Whether the user has enabled email marketing notifications.
      - name: load_date
        description: Timestamp of the most recent data load.
